<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Chat - Seurt</title>
    <link rel="stylesheet" href="/static/style.css">
</head>
<body>
    <nav class="nav">
        <div class="container nav-container">
            <a href="/" class="nav-brand">Seurt</a>
            <div class="nav-links">
                <a href="/chats">Back to Chats</a>
                <a href="/">Home</a>
            </div>
        </div>
    </nav>

    <div class="container">
        <div id="alert-container"></div>

        <div class="card">
            <div class="card-header" id="chat-header">
                <h1 class="card-title">Loading...</h1>
                <p class="card-description" id="chat-description">Please wait while we load the chat</p>
            </div>

            <div id="chat-info" class="hidden mb-4">
                <div class="flex items-center justify-between mb-4">
                    <div>
                        <strong>Members:</strong> <span id="member-count">0</span>
                    </div>
                    <div class="text-sm" id="chat-created">
                        Created: <span id="created-date"></span>
                    </div>
                </div>
            </div>

            <div class="message-container" id="messages-container">
                <div class="loading">
                    <div class="spinner"></div>
                </div>
            </div>

            <form class="message-input-form" id="send-message-form">
                <input type="text" id="message-input" class="input message-input" placeholder="Type your message..." required>
                <button type="submit" class="button button-primary">Send</button>
            </form>
        </div>
    </div>

    <script>
        const chatId = '{{ id }}';
        let currentUser = null;
        let chatData = null;

        async function getCurrentUser() {
            try {
                const response = await fetch('/api/user/me');
                if (response.ok) {
                    const result = await response.json();
                    if (result.success) {
                        return result.data.user;
                    }
                }
            } catch (error) {
                console.error('Error getting current user:', error);
            }
            return null;
        }

        async function loadChat() {
            try {
                const response = await fetch(`/api/chat/${chatId}`);
                if (response.ok) {
                    const result = await response.json();
                    if (result.success) {
                        return result.data.chat;
                    }
                }
            } catch (error) {
                console.error('Error loading chat:', error);
            }
            return null;
        }

        async function sendMessage(content) {
            const response = await fetch(`/api/chat/${chatId}/message`, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({ content })
            });
            return await response.json();
        }

        function showAlert(message, type = 'error') {
            const alertContainer = document.getElementById('alert-container');
            alertContainer.innerHTML = `<div class="alert alert-${type}">${message}</div>`;
        }

        function renderMessages(messages) {
            const container = document.getElementById('messages-container');
            
            if (!messages || messages.length === 0) {
                container.innerHTML = `
                    <div style="text-align: center; padding: 2rem; color: hsl(var(--muted-foreground));">
                        <p>No messages yet. Be the first to send a message!</p>
                    </div>
                `;
                return;
            }

            const messagesList = messages.map(message => {
                const isOwn = currentUser && message.sender_id === currentUser.user_id;
                const messageClass = isOwn ? 'message message-own' : 'message message-other';
                const timestamp = new Date(message.timestamp).toLocaleTimeString();
                
                return `
                    <div class="${messageClass}">
                        <div class="message-header">
                            ${isOwn ? 'You' : message.sender_id} â€¢ ${timestamp}
                        </div>
                        <div>${message.content}</div>
                    </div>
                `;
            }).join('');

            container.innerHTML = messagesList;
            container.scrollTop = container.scrollHeight;
        }

        function updateChatHeader() {
            if (!chatData) return;

            const header = document.getElementById('chat-header');
            const chatInfo = document.getElementById('chat-info');
            
            header.querySelector('.card-title').textContent = chatData.info.name;
            header.querySelector('.card-description').textContent = `Chat ID: ${chatData.info.chat_id}`;
            
            document.getElementById('member-count').textContent = chatData.info.members.length;
            document.getElementById('created-date').textContent = new Date(chatData.info.created_at).toLocaleDateString();
            
            chatInfo.classList.remove('hidden');
        }

        async function initializeChat() {
            currentUser = await getCurrentUser();
            chatData = await loadChat();

            if (!chatData) {
                showAlert('Failed to load chat. Please try again or go back to chats.');
                return;
            }

            updateChatHeader();
            renderMessages(chatData.messages);
        }

        document.getElementById('send-message-form').addEventListener('submit', async (e) => {
            e.preventDefault();
            
            const messageInput = document.getElementById('message-input');
            const content = messageInput.value.trim();
            
            if (!content) return;

            const submitBtn = e.target.querySelector('button[type="submit"]');
            submitBtn.disabled = true;
            submitBtn.textContent = 'Sending...';

            try {
                const result = await sendMessage(content);
                
                if (result.success) {
                    messageInput.value = '';
                    
                    const newMessage = {
                        message_id: result.data.message_id,
                        content: result.data.content,
                        sender_id: currentUser ? currentUser.user_id : 'unknown',
                        timestamp: result.data.timestamp
                    };
                    
                    if (chatData && chatData.messages) {
                        chatData.messages.push(newMessage);
                        renderMessages(chatData.messages);
                    }
                } else {
                    showAlert(result.error_msg || 'Failed to send message');
                }
            } catch (error) {
                showAlert('Network error. Please try again.');
            } finally {
                submitBtn.disabled = false;
                submitBtn.textContent = 'Send';
            }
        });

        initializeChat();
    </script>
</body>
</html>