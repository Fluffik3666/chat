<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Chat - Seurt</title>
    <link rel="stylesheet" href="/static/style.css">
</head>
<body>
    <nav class="nav">
        <div class="container nav-container">
            <a href="/" class="nav-brand">Seurt</a>
            <div class="nav-links" id="nav-links">
                <a href="/chats">Back to Chats</a>
            </div>
        </div>
    </nav>

    <div class="container">
        <div id="alert-container"></div>

        <div class="card">
            <div class="card-header" id="chat-header">
                <h1 class="card-title">Loading...</h1>
                <p class="card-description" id="chat-description">Please wait while we load the chat</p>
            </div>

            <div id="chat-info" class="hidden mb-4">
                <div class="flex items-center justify-between mb-4">
                    <div>
                        <strong>Members:</strong> <span id="member-count">0</span>
                        <button class="button button-secondary" style="margin-left: 1rem; padding: 0.25rem 0.5rem; font-size: 0.75rem;" onclick="showChatSettings()">Settings</button>
                    </div>
                    <div class="text-sm" id="chat-created">
                        Created: <span id="created-date"></span>
                    </div>
                </div>
            </div>

            <div class="card hidden" id="chat-settings-card" style="margin-bottom: 1rem;">
                <div class="card-header">
                    <h3 class="card-title">Chat Settings</h3>
                    <p class="card-description">Manage this chat</p>
                </div>
                
                <div class="mb-4">
                    <h4 class="font-semibold mb-2">Add Member</h4>
                    <div class="flex gap-2">
                        <input type="text" id="add-member-username" class="input" placeholder="Enter username" style="flex: 1;">
                        <button type="button" class="button button-primary" onclick="addMemberToChat()">Add</button>
                    </div>
                </div>
                
                <div class="mb-4">
                    <h4 class="font-semibold mb-2">Current Members</h4>
                    <div id="current-members-list">Loading...</div>
                </div>
                
                <div class="flex gap-2">
                    <button type="button" class="button button-secondary" onclick="hideChatSettings()">Close</button>
                    <button type="button" class="button button-destructive" onclick="deleteChat()">Delete Chat</button>
                </div>
            </div>

            <div class="message-container" id="messages-container">
                <div class="loading">
                    <div class="spinner"></div>
                </div>
            </div>

            <form class="message-input-form" id="send-message-form">
                <input type="text" id="message-input" class="input message-input" placeholder="Type your message..." required>
                <button type="submit" class="button button-primary">Send</button>
            </form>
        </div>
    </div>

    <script>
        const chatId = '{{ id }}';
        let currentUser = null;
        let chatData = null;

        async function getCurrentUser() {
            try {
                const response = await fetch('/api/user/me');
                if (response.ok) {
                    const result = await response.json();
                    if (result.success) {
                        return result.data.user;
                    }
                }
            } catch (error) {
                console.error('Error getting current user:', error);
            }
            return null;
        }

        async function getUserByUsername(username) {
            try {
                const response = await fetch(`/api/user/by-username/${username}`);
                if (response.ok) {
                    const result = await response.json();
                    if (result.success) {
                        return result.data.user;
                    }
                }
            } catch (error) {
                console.error('Error finding user:', error);
            }
            return null;
        }

        async function addUserToChat(chatId, userId) {
            const response = await fetch(`/api/chat/${chatId}/add-member`, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({ user_id: userId })
            });
            return await response.json();
        }

        async function removeUserFromChat(chatId, userId) {
            const response = await fetch(`/api/chat/${chatId}/remove-member`, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({ user_id: userId })
            });
            return await response.json();
        }

        async function deleteChatRequest(chatId) {
            const response = await fetch(`/api/chat/${chatId}`, {
                method: 'DELETE'
            });
            return await response.json();
        }

        async function loadChat() {
            try {
                const response = await fetch(`/api/chat/${chatId}`);
                if (response.ok) {
                    const result = await response.json();
                    if (result.success) {
                        return result.data.chat;
                    } else if (result.error_msg && result.error_msg.includes('not a member')) {
                        showAlert('You are not a member of this chat.', 'error');
                        setTimeout(() => {
                            window.location.href = '/chats';
                        }, 2000);
                        return null;
                    }
                }
            } catch (error) {
                console.error('Error loading chat:', error);
            }
            return null;
        }

        async function getUserInfo(userId) {
            try {
                const response = await fetch(`/api/user/${userId}`);
                if (response.ok) {
                    const result = await response.json();
                    if (result.success) {
                        return result.data.user;
                    }
                }
            } catch (error) {
                console.error('Error getting user info:', error);
            }
            return { username: userId }; // Fallback to showing ID
        }

        async function sendMessage(content) {
            const response = await fetch(`/api/chat/${chatId}/message`, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({ content })
            });
            return await response.json();
        }

        function showAlert(message, type = 'error') {
            const alertContainer = document.getElementById('alert-container');
            alertContainer.innerHTML = `<div class="alert alert-${type}">${message}</div>`;
        }

        let userCache = {};

        async function renderMessages(messages) {
            const container = document.getElementById('messages-container');
            
            if (!messages || messages.length === 0) {
                container.innerHTML = `
                    <div style="text-align: center; padding: 2rem; color: hsl(var(--muted-foreground));">
                        <p>No messages yet. Be the first to send a message!</p>
                    </div>
                `;
                return;
            }

            // Get usernames for all unique sender IDs
            const uniqueSenderIds = [...new Set(messages.map(m => m.sender_id))];
            for (const senderId of uniqueSenderIds) {
                if (!userCache[senderId]) {
                    const userInfo = await getUserInfo(senderId);
                    userCache[senderId] = userInfo.username;
                }
            }

            const messagesList = messages.map(message => {
                const isOwn = currentUser && message.sender_id === currentUser.user_id;
                const messageClass = isOwn ? 'message message-own' : 'message message-other';
                const timestamp = new Date(message.timestamp).toLocaleTimeString();
                const senderName = userCache[message.sender_id] || message.sender_id;
                
                return `
                    <div class="${messageClass}">
                        <div class="message-header">
                            ${isOwn ? 'You' : senderName} â€¢ ${timestamp}
                        </div>
                        <div>${message.content}</div>
                    </div>
                `;
            }).join('');

            container.innerHTML = messagesList;
            container.scrollTop = container.scrollHeight;
        }

        function updateChatHeader() {
            if (!chatData) return;

            const header = document.getElementById('chat-header');
            const chatInfo = document.getElementById('chat-info');
            
            header.querySelector('.card-title').textContent = chatData.info.name;
            header.querySelector('.card-description').textContent = `Chat ID: ${chatData.info.chat_id}`;
            
            document.getElementById('member-count').textContent = chatData.info.members.length;
            document.getElementById('created-date').textContent = new Date(chatData.info.created_at).toLocaleDateString();
            
            chatInfo.classList.remove('hidden');
        }

        function showChatSettings() {
            document.getElementById('chat-settings-card').classList.remove('hidden');
            renderCurrentMembers();
        }

        function hideChatSettings() {
            document.getElementById('chat-settings-card').classList.add('hidden');
        }

        async function renderCurrentMembers() {
            const container = document.getElementById('current-members-list');
            
            if (!chatData || !chatData.info.members) {
                container.innerHTML = 'No members found';
                return;
            }

            // Get usernames for all members
            const memberData = [];
            for (const memberId of chatData.info.members) {
                if (!userCache[memberId]) {
                    const userInfo = await getUserInfo(memberId);
                    userCache[memberId] = userInfo.username;
                }
                memberData.push({
                    id: memberId,
                    username: userCache[memberId]
                });
            }

            const membersList = memberData.map(member => {
                const isCurrentUser = currentUser && member.id === currentUser.user_id;
                const canRemove = !isCurrentUser; // Can't remove yourself
                
                return `
                    <div class="flex items-center justify-between" style="padding: 0.5rem; border: 1px solid hsl(var(--border)); border-radius: var(--radius); margin-bottom: 0.5rem;">
                        <span>${member.username} ${isCurrentUser ? '(You)' : ''}</span>
                        ${canRemove ? `<button type="button" class="button button-destructive" style="padding: 0.25rem 0.5rem; font-size: 0.75rem;" onclick="removeMemberFromChat('${member.id}')">Remove</button>` : ''}
                    </div>
                `;
            }).join('');

            container.innerHTML = membersList;
        }

        async function addMemberToChat() {
            const usernameInput = document.getElementById('add-member-username');
            const username = usernameInput.value.trim();
            
            if (!username) {
                showAlert('Please enter a username');
                return;
            }

            const user = await getUserByUsername(username);
            if (!user) {
                showAlert('User not found');
                return;
            }

            if (chatData.info.members.includes(user.user_id)) {
                showAlert('User is already a member');
                return;
            }

            try {
                const result = await addUserToChat(chatId, user.user_id);
                if (result.success) {
                    showAlert('Member added successfully!', 'success');
                    usernameInput.value = '';
                    chatData = await loadChat(); // Refresh chat data
                    updateChatHeader();
                    renderCurrentMembers();
                } else {
                    showAlert(result.error_msg || 'Failed to add member');
                }
            } catch (error) {
                showAlert('Network error. Please try again.');
            }
        }

        async function removeMemberFromChat(userId) {
            if (!confirm('Are you sure you want to remove this member?')) {
                return;
            }

            try {
                const result = await removeUserFromChat(chatId, userId);
                if (result.success) {
                    showAlert('Member removed successfully!', 'success');
                    chatData = await loadChat(); // Refresh chat data
                    updateChatHeader();
                    renderCurrentMembers();
                } else {
                    showAlert(result.error_msg || 'Failed to remove member');
                }
            } catch (error) {
                showAlert('Network error. Please try again.');
            }
        }

        async function deleteChat() {
            if (!confirm('Are you sure you want to delete this chat? This action cannot be undone.')) {
                return;
            }

            try {
                const result = await deleteChatRequest(chatId);
                if (result.success) {
                    showAlert('Chat deleted successfully!', 'success');
                    setTimeout(() => {
                        window.location.href = '/chats';
                    }, 2000);
                } else {
                    showAlert(result.error_msg || 'Failed to delete chat');
                }
            } catch (error) {
                showAlert('Network error. Please try again.');
            }
        }

        async function initializeChat() {
            currentUser = await getCurrentUser();
            
            // Update nav for signed in users
            if (currentUser) {
                const navLinks = document.getElementById('nav-links');
                navLinks.innerHTML = `
                    <a href="/chats">Back to Chats</a>
                    <a href="/accounts/${currentUser.user_id}">My Profile</a>
                    <button class="button button-secondary" onclick="logout()" style="padding: 0.25rem 0.5rem; font-size: 0.75rem;">Logout</button>
                `;
            }
            
            chatData = await loadChat();

            if (!chatData) {
                showAlert('Failed to load chat. Please try again or go back to chats.');
                return;
            }

            updateChatHeader();
            renderMessages(chatData.messages);
        }

        document.getElementById('send-message-form').addEventListener('submit', async (e) => {
            e.preventDefault();
            
            const messageInput = document.getElementById('message-input');
            const content = messageInput.value.trim();
            
            if (!content) return;

            const submitBtn = e.target.querySelector('button[type="submit"]');
            submitBtn.disabled = true;
            submitBtn.textContent = 'Sending...';

            try {
                const result = await sendMessage(content);
                
                if (result.success) {
                    messageInput.value = '';
                    
                    const newMessage = {
                        message_id: result.data.message_id,
                        content: result.data.content,
                        sender_id: currentUser ? currentUser.user_id : 'unknown',
                        timestamp: result.data.timestamp
                    };
                    
                    if (chatData && chatData.messages) {
                        chatData.messages.push(newMessage);
                        renderMessages(chatData.messages);
                    }
                } else {
                    showAlert(result.error_msg || 'Failed to send message');
                }
            } catch (error) {
                showAlert('Network error. Please try again.');
            } finally {
                submitBtn.disabled = false;
                submitBtn.textContent = 'Send';
            }
        });

        initializeChat();

        // Auto-refresh messages every 5 seconds
        setInterval(async () => {
            if (chatData) {
                const freshChat = await loadChat();
                if (freshChat && freshChat.messages) {
                    chatData.messages = freshChat.messages;
                    await renderMessages(chatData.messages);
                }
            }
        }, 5000);

        async function logout() {
            try {
                await fetch('/api/logout', { method: 'POST' });
                window.location.href = '/';
            } catch (error) {
                console.error('Logout error:', error);
                window.location.href = '/';
            }
        }
    </script>
</body>
</html>